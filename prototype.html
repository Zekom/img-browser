<html>
	<head><script type="text/javascript"></script> </head>
<body>
	<div>
		<div>
			<input type="button" value="darkenTest" onclick="darkenTest()">
			<input type="button" value="bwTest" onclick="bwTest()">
			<input type="button" value="histTest" onclick="histTest()">
			<input type="button" value="invertTest" onclick="invertTest()">
		</div>
		<div>
			<canvas id="cnv" style="border:3px red solid;"></canvas>
			<!--
			<canvas id="cnv2" style="border:3px red solid;"></canvas>
			-->
			<output id="output"></output>
		</div>
	</div>
<script>
	function handleFileSelect(evt) 
	{
		evt.stopPropagation();
		evt.preventDefault();
		var files = evt.dataTransfer.files; 
		if ( files.length > 1 )
		{	alert("only one file please");}
		else
		{
			var file = files[0];
			var reader = new FileReader();  
			reader.onload = function(e) 
			{  
				var canvas = document.getElementById("cnv");
				//var canvas2 = document.getElementById("cnv2");
				//canvas2.x=300;
				var context = canvas.getContext("2d");
				var imageObj = new Image();
				imageObj.onload = function()
				{
					canvas.width = this.width;
					canvas.height = this.height;
					context.drawImage(this,0, 0);
				}
				imageObj.src = e.target.result;
			}  
			reader.readAsDataURL(file); 
		}
	}
	function repairCanvasSize()
	{canvas }
	function handleDragOver(evt) {
		evt.stopPropagation();
		evt.preventDefault();
		evt.dataTransfer.dropEffect = 'copy'; 
	}
	var dropZone = document.getElementById('cnv');
	dropZone.addEventListener('dragover', handleDragOver, false);
	dropZone.addEventListener('drop', handleFileSelect, false);  
	var context = dropZone.getContext("2d");
	dropZone.width = 300;
	dropZone.height = 300;
	context.fillText("Drag-Drop an image here", 85, 140); 
	function darkenTest()
	{
		var canvas = document.getElementById('cnv');
		var ctx = canvas.getContext("2d");
		var factor = prompt("Enter factor. <1 for darken, >1 for lighten");
		var imagedata = context.getImageData( 0, 0, canvas.width, canvas.height );
		var data = imagedata.data;
		for(var i = 0; i < data.length; i += 4) {
			  data[i]     = data[i]    * factor;
			  data[i + 1] = data[i + 1]*factor;
			  data[i + 2] = data[i + 2]*factor; 
			}
		imagedata.data = data;
		ctx.putImageData( imagedata, 0, 0  );
	}
	function bwTest()
	{
		var canvas = document.getElementById('cnv');
		var ctx = canvas.getContext("2d");
		var imagedata = ctx.getImageData(0,0,canvas.width,canvas.height );
		var data = imagedata.data;
		var f=0;
		for(var i = 0; i < data.length; i += 4) 
		{
			f=(data[i]+data[i+1]+data[i+2])/3;
			data[i]=f;
			data[i+1]=f;
			data[i+2]=f; 
		}
		imagedata.data = data;
		ctx.putImageData( imagedata, 0, 0  );
	}
	function invertTest()
	{
		var canvas = document.getElementById('cnv');
		var ctx = canvas.getContext("2d");
		var imagedata = ctx.getImageData(0,0,canvas.width,canvas.height);
		var data = imagedata.data;
		for(var i = 0; i < data.length; i += 4) 
		{
			data[i]=255-data[i];		//red
			data[i+1]=255-data[i+1];	//green
			data[i+2]=255-data[i+2];	//blue
		}
		ctx.putImageData(imagedata,0,0);
	}
	function histTest() //o=r,1=g,2=b,3=BW
	{
		var canvas = document.getElementById("cnv");
		var ctx = canvas.getContext("2d");
		var imagedata = context.getImageData(0,0,canvas.width,canvas.height );
		var data = imagedata.data;
		//init arrays
		var hist = {l:[],r:[],g:[],b:[]};
        for ( i = 0; i < 256; i ++ )
		{
            hist.l[i] = hist.r[i] = hist.g[i] = hist.b[i] = 0;
        }
		//calc hist
		for ( i = 0; i < data.length; i += 4 )
		{
            var r = data[i],g = data[i+1],b = data[i+2];
            var l = Math.round((r+g+b)/3);
            hist.l[l] ++;
            hist.r[r] ++;
            hist.g[g] ++;
            hist.b[b] ++;
        }
		//draw histogram
		var canvas = document.getElementById('cnv');
		canvas.width=600;
		canvas.height=400;
		var ctx = canvas.getContext("2d");
		ctx.clearRect(0,0,canvas.width,canvas.height);
		X=hist.l; //menjamo l,r,g,b
		for(var i=0;i<X.length;i++) 
		{
			ctx.beginPath();
			ctx.moveTo(i*2,400);
			ctx.lineTo(i*2,400-Math.round(X[i]/10));
			ctx.stroke();
		}
		ctx.putImageData(imageData,0,0);
	}
	</script>
	</body>
</html>